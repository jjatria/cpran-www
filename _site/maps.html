<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <title>JJA - Maps Test</title>
  <meta charset="utf-8" />
  <link rel="shortcut icon" href="images/favicon.ico" />
  <link rel="stylesheet" href="/assets/lib/leaflet/leaflet.css" />
  <link rel="stylesheet" href="/assets/lib/leaflet/plugins/Label/leaflet.label.css" />
  <link rel="stylesheet" href="/assets/lib/leaflet/plugins/MarkerCluster/MarkerCluster.css" />
  <link rel="stylesheet" href="/assets/lib/leaflet/plugins/MarkerCluster/MarkerCluster.Default.css" />
  <!--[if lte IE 8]><link rel="stylesheet" href="lib/leaflet/MarkerCluster.Default.ie.css" /><![endif]-->
  <!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6/leaflet.ie.css" /><![endif]-->
  <script src="/assets/lib/jquery.js"></script>
  <script src="/assets/lib/leaflet/leaflet-src.js"></script>
  <script src="/assets/lib/leaflet/plugins/Label/leaflet.label.js"></script>
  <script src="/assets/lib/leaflet/plugins/MarkerCluster/leaflet.markercluster.js"></script>
  <script src="/assets/lib/leaflet/plugins/AnimatedMarker/AnimatedMarker.js"></script>
  <style>
    html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
  </style>
</head>

<body>

<div id="map">
</div>

<script type="text/javascript">
  // Get url parameters
  // as per http://blog.thematicmapping.org/2012/10/how-to-control-your-leaflet-map-with.html
  var params = {};
  window.location.href.replace(
    /[?&]+([^=&]+)=([^&]*)/gi,
    function(m, key, value) {
      params[key] = value;
    }
  );

  // TODO [layers] implement a better selection of active layers
  if (params.layers) {
    var activeLayers = params.layers.split(',').map(function(item) {
      return layers[item];
    });
  }

  var map = L.map('map',{
        center: [params.lat || 42.3801415, params.lng || -71.1287875 ],
        zoom: params.zoom || 7,
        worldCopyJump: true,
        layers: activeLayers,
      }
    )
    .on('click', onMapClick);

// 	map.addLayer(L.animatedMarker(L.polyline([[-31.35364, -25.3125],[68.39918, 259.45313]]).getLatLngs()));
// 	map.addLayer(L.Marker([-31.35364, -25.3125]));

  var styles = {
    car: {
      color: "#cb4b16",
      opacity: 0.8
    },
    plane: {
      color: "#2aa198",
      opacity: 0.5
    },
    foot: {
      color: "#859900",
      opacity: 0.8
    },
    train: {
      color: "#6c71c4",
      opacity: 0.8
    },
    bus: {
      color: "#dc322f",
      opacity: 0.8
    },
    taxi: {
      color: "#dc322f",
      opacity: 0.8
    },
    bike: {
      color: "#b58900",
      opacity: 0.8
    },
    ferry: {
      color: "#268bd2",
      opacity: 0.8
    },
  };

  var markers = new L.MarkerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 50
  });
  var overlays = {
    "Markers": markers,
  };
  var myLayerControl = L.control.layers({}, overlays).addTo(map);
  L.control.scale().addTo(map);

  if (L.DomUtil.TRANSITION) {
    console.log("Transitions");
  } else {
    console.log("No transitions");
  }

  // TODO [layers] implement a better solution for loading layers
  loadTrack("/assets/geojson/jogasaki.json");
  loadTrack("/assets/geojson/katsunuma.json");
  loadTrack("/assets/geojson/mitake.json");
  loadTrack("/assets/geojson/nagoya.json");
  loadTrack("/assets/geojson/akitawa.json");
  loadTrack("/assets/geojson/chile.json");
  loadTrack("/assets/geojson/barcelona.json");
  loadTrack("/assets/geojson/madrid.json");
  loadTrack("/assets/geojson/india.json");
  loadTrack("/assets/geojson/hong_kong.json");
  loadTrack("/assets/geojson/seoul.json");
  loadTrack("/assets/geojson/rye.json");
  loadTrack("/assets/geojson/paris.json");
  loadTrack("/assets/geojson/cote_dazur.json");
  loadTrack("/assets/geojson/seven_sisters.json");
  loadTrack("/assets/geojson/fujisan.json");
  loadTrack("/assets/geojson/hiroshima.json");
  loadTrack("/assets/geojson/oshima.json");
  loadTrack("/assets/geojson/kanazawa.json");
  loadTrack("/assets/geojson/ireland.json");
  loadTrack("/assets/geojson/norwich.json");
  loadTrack("/assets/geojson/telford.json");
  loadTrack("/assets/geojson/jurassic_coast.json");
  loadTrack("/assets/geojson/tanglewood.json");
  loadTrack("/assets/geojson/rockland.json");
  loadTrack("/assets/geojson/stamford.json");

  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: 'Map by <a href="http://openstreetmap.org">OpenStreetMap</a> (<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>), tiles by <a href="http://osm.org">OpenStreetMap</a>',
    maxZoom: 18
  }).addTo(map);

  function loadTrack(url) {
    jQuery.ajax({
      type: "GET",
      url: url,
      dataType: "json",
      success: function(data) {
        var a = {};
        a.paths = loadPaths(data);
        a.markers = loadMarkers(data);
        a.polygons = loadPolygons(data);
        a.paths.addTo(map);
        a.polygons.addTo(map);
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        alert("Error processing GeoJSON data");
      }
    });
  }

  function loadPaths (data) {
    var g = L.geoJson(data, {
      style: stylePaths,
      onEachFeature: onEachFeature,
      filter: function(feature, layer) {
        return (feature.geometry.type == "LineString");
      }
    });
    if (data.properties && data.properties.name) {
      myLayerControl.addOverlay(g, data.properties.name);
      console.log("Loaded " + data.properties.name);
    }
    return g;
  }

  function loadPolygons (data) {
    return L.geoJson(data, {
      style: stylePolygons,
      onEachFeature: onEachFeature,
      filter: function(feature, layer) {
        return (
          feature.geometry.type == "Polygon" ||
          feature.geometry.type == "MultiPolygon"
        );
      }
    });
  }

  function loadMarkers (data) {
    var g = L.geoJson(data, {
      style: styleMarkers,
      onEachFeature: onEachFeature,
      pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, {
          radius: 8,
          fillColor: "#fff",
          color: "#666",
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8,
        });
      },
      filter: function(feature, layer) {
        return (feature.geometry.type == "Point");
      }
    });
    markers.addLayer(g);
    return g;
  }

  function styleMarkers(feature) {
  }

  function stylePolygons(feature) {
  }

  function stylePaths(feature) {
    if (feature.properties && feature.properties.vehicle) {
      return styles[feature.properties.vehicle];
    }
  }

  function onEachFeature(feature, layer) {
    if (feature.properties.id) {
      layer._leaflet_id = feature.properties.id;
    }
    switch (feature.geometry.type) {
      case "LineString":
        layer.on('click', function (e) {
            var lls = L.GeoJSON.coordsToLatLngs(feature.geometry.coordinates);
            if (feature.properties.bounce) {
              lls = lls.concat(L.GeoJSON.coordsToLatLngs(feature.geometry.coordinates).reverse());
            }
            var line = L.polyline(lls);
            var anim = L.animatedMarker(line.getLatLngs(),{
              distance: 100000,  // meters
              interval: 1000, // milliseconds
              autoStart: false,
              icon: L.icon({
                iconUrl: "images/mapicons/" + feature.properties.vehicle + ".png",
                iconAnchor: [15, 35]
              }),
              onEnd: function() {
                $(this._shadow).fadeOut();
                $(this._icon).fadeOut(3000, function(){
                  map.removeLayer(this);
                });
                if (feature.properties.next) {
                  map._layers[feature.properties.next].fire('click');
                }
              }
            });
            map.addLayer(anim);
            $(anim._icon).hide().fadeIn(1000, function(){
              anim.start();
            });
        });
      case "Point":
      case "Polygon":
      case "MultiPolygon":
        layer.bindLabel(feature.properties.name);
        break
    }
  }

  function onMapClick(e) {
    console.log("You clicked the map at " + e.latlng);
  }

  function zeropad(number, length) {
    var str = '' + number;
    while (str.length < length) {
      str = '0' + str;
    }
    return str;
  }

  // Haversine formula
  // From http://stackoverflow.com/a/1502821/807650
  function rad (x) { return x*Math.PI/180; }

  function getDistance (p1, p2) {
    var R = 6371; // earth's mean radius in km
    var dLat  = rad(p2.lat - p1.lat);
    var dLong = rad(p2.lng - p1.lng);
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(rad(p1.lat)) * Math.cos(rad(p2.lat)) * Math.sin(dLong/2) * Math.sin(dLong/2);
    var c = 2 * Math.asin(Math.sqrt(a));
    var d = R * c;
    return d.toFixed(3);
  }

</script>
</body>
</html>
